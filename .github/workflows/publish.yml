name: Manual Publish

on:
  workflow_dispatch:

jobs:
  test-and-publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Run Tests
        # Run tests with conservative memory settings to avoid OOM kills.
        env:
          CARGO_BUILD_JOBS: 1
          CARGO_INCREMENTAL: 0
          RUSTFLAGS: -C debuginfo=0 -C codegen-units=1
        run: cargo test -j 1 -- --test-threads=1


      - name: Cargo Publish
        # This only runs if the 'Run Tests' step above succeeded (exit code 0)
        env:
          CARGO_BUILD_JOBS: 1
          CARGO_INCREMENTAL: 0
          RUSTFLAGS: -C debuginfo=0 -C codegen-units=1
        run: cargo publish --token ${{ secrets.CRATES_IO_TOKEN }}
